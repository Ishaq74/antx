---
export const prerender = false;
import BaseLayout from "@layouts/BaseLayout.astro";
import Input from "@components/UI/Input.astro";
import Button from "@components/UI/Button.astro";
import Alert from "@components/UI/Alert.astro";
import FormGroup from "@components/UI/FormGroup.astro";

// Check if user is already authenticated
const user = Astro.locals.user;
if (user) {
  return Astro.redirect("/");
}
---

<BaseLayout title="Mot de passe oublié" description="Réinitialisez votre mot de passe">
  <div class="auth-container">
    <div class="auth-card">
      <div class="auth-header">
        <h1>Mot de passe oublié</h1>
        <p>Nous allons vous envoyer un code pour réinitialiser votre mot de passe</p>
      </div>

      <!-- Step 1: Request OTP -->
      <div id="request-step" class="step-content">
        <form id="request-form" class="auth-form">
          <FormGroup label="Adresse email" id="email" required helpText="Entrez l'email associé à votre compte">
            <Input
              type="email"
              id="email"
              name="email"
              placeholder="votre@email.com"
              required
            />
          </FormGroup>
          
          <Button type="submit" fullWidth>Envoyer le code</Button>
          
          <Alert variant="error" id="request-error" style="display: none;" />
          <Alert variant="success" id="request-success" style="display: none;" />
        </form>
      </div>

      <!-- Step 2: Verify OTP and Set New Password -->
      <div id="reset-step" class="step-content" style="display: none;">
        <form id="reset-form" class="auth-form">
          <FormGroup label="Code de vérification" id="otp" required helpText="Entrez le code reçu par email">
            <Input
              type="text"
              id="otp"
              name="otp"
              placeholder="000000"
              maxlength="6"
              pattern="[0-9]{6}"
              required
            />
          </FormGroup>
          
          <FormGroup label="Nouveau mot de passe" id="newPassword" required>
            <Input
              type="password"
              id="newPassword"
              name="newPassword"
              placeholder="Nouveau mot de passe sécurisé"
              minlength="8"
              required
            />
            <div class="password-strength" id="password-strength"></div>
          </FormGroup>
          
          <FormGroup label="Confirmer le mot de passe" id="confirmPassword" required>
            <Input
              type="password"
              id="confirmPassword"
              name="confirmPassword"
              placeholder="Confirmez votre nouveau mot de passe"
              required
            />
          </FormGroup>
          
          <Button type="submit" fullWidth>Réinitialiser le mot de passe</Button>
          <Button type="button" variant="secondary" fullWidth id="back-btn">Retour</Button>
          
          <Alert variant="error" id="reset-error" style="display: none;" />
          <Alert variant="success" id="reset-success" style="display: none;" />
        </form>
      </div>

      <!-- Step 3: Success -->
      <div id="success-step" class="step-content" style="display: none;">
        <div class="success-message">
          <div class="success-icon">✅</div>
          <h2>Mot de passe réinitialisé !</h2>
          <p>Votre mot de passe a été mis à jour avec succès.</p>
          <Button href="/connexion" fullWidth>Se connecter</Button>
        </div>
      </div>

      <div class="auth-footer">
        <p>Vous vous souvenez de votre mot de passe ? <a href="/connexion" class="link">Se connecter</a></p>
        <p>Pas encore de compte ? <a href="/inscription" class="link">Créer un compte</a></p>
      </div>
    </div>
  </div>
</BaseLayout>

<!-- All styles now handled by theme.css -->

<style>
  /* Custom styles for success message */
  .success-message {
    text-align: center;
    padding: var(--space-2xl);
  }

  .success-icon {
    font-size: var(--font-size-4xl);
    margin-bottom: var(--space-lg);
  }

  .success-message h2 {
    margin: 0 0 var(--space-lg);
    color: var(--c-success);
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
  }

  .success-message p {
    margin: 0 0 var(--space-2xl);
    color: var(--c-foreground-muted);
    font-size: var(--font-size-base);
  }
</style>

<script type="module">
  import { authClient } from "../src/lib/auth-client";
  import { mapErrorMessage, getSuccessMessage, getLoadingMessage } from "../src/lib/client/error-messages";

  let currentEmail = '';

  // Password strength checking
  const passwordInput = document.getElementById('newPassword');
  const strengthDiv = document.getElementById('password-strength');

  passwordInput?.addEventListener('input', () => {
    const password = passwordInput.value;
    const strength = calculatePasswordStrength(password);
    
    strengthDiv.className = 'password-strength ' + strength.class;
    strengthDiv.textContent = strength.text;
  });

  function calculatePasswordStrength(password) {
    if (password.length < 6) {
      return { class: 'weak', text: 'Mot de passe trop court' };
    }
    
    let score = 0;
    if (password.length >= 8) score++;
    if (/[a-z]/.test(password)) score++;
    if (/[A-Z]/.test(password)) score++;
    if (/\d/.test(password)) score++;
    if (/[^a-zA-Z\d]/.test(password)) score++;
    
    if (score < 3) {
      return { class: 'weak', text: 'Mot de passe faible' };
    } else if (score < 4) {
      return { class: 'medium', text: 'Mot de passe moyen' };
    } else {
      return { class: 'strong', text: 'Mot de passe fort' };
    }
  }

  // Error and success display functions
  function showError(elementId, message) {
    const errorElement = document.getElementById(elementId);
    errorElement.textContent = message;
    errorElement.style.display = 'block';
    
    // Hide corresponding success message
    const successElementId = elementId.replace('-error', '-success');
    const successElement = document.getElementById(successElementId);
    if (successElement) {
      successElement.style.display = 'none';
    }
  }

  function hideError(elementId) {
    const errorElement = document.getElementById(elementId);
    errorElement.style.display = 'none';
  }

  function showSuccess(elementId, message) {
    const successElement = document.getElementById(elementId);
    if (successElement) {
      successElement.textContent = message;
      successElement.style.display = 'block';
      
      // Hide corresponding error message
      const errorElementId = elementId.replace('-success', '-error');
      const errorElement = document.getElementById(errorElementId);
      if (errorElement) {
        errorElement.style.display = 'none';
      }
    }
  }

  // Show specific step
  function showStep(stepId) {
    const steps = ['request-step', 'reset-step', 'success-step'];
    steps.forEach(id => {
      document.getElementById(id).style.display = id === stepId ? 'block' : 'none';
    });
  }

  // Step 1: Request OTP
  document.getElementById('request-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    hideError('request-error');
    
    const formData = new FormData(e.target);
    const email = formData.get('email');
    currentEmail = email;
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = getLoadingMessage('otp-sending');
    
    try {
      // Utilise le endpoint natif Better Auth
      await fetch('/forget-password/email-otp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });
      // Toujours afficher un message générique, même si l’email n’existe pas
      showSuccess('request-success', "Si un compte existe, un code a été envoyé à cette adresse.");
      showStep('reset-step');
    } catch (error) {
      // Toujours afficher le message générique
      showSuccess('request-success', "Si un compte existe, un code a été envoyé à cette adresse.");
      showStep('reset-step');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Envoyer le code';
    }
  });

  // Step 2: Verify OTP and Reset Password
  document.getElementById('reset-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    hideError('reset-error');
    
    const formData = new FormData(e.target);
    const otp = formData.get('otp');
    const newPassword = formData.get('newPassword');
    const confirmPassword = formData.get('confirmPassword');
    
    // Validate password match
    if (newPassword !== confirmPassword) {
      showError('reset-error', 'Les mots de passe ne correspondent pas');
      return;
    }
    
    const submitBtn = e.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = getLoadingMessage('password-resetting');
    
    try {
      // Utilise le endpoint natif Better Auth
      const res = await fetch('/email-otp/reset-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: currentEmail, otp, password: newPassword })
      });
      if (res.ok) {
        showSuccess('reset-success', getSuccessMessage('password-reset'));
        showStep('success-step');
      } else {
        // Affiche un message d'erreur générique
        showError('reset-error', 'Impossible de réinitialiser le mot de passe. Vérifiez le code ou réessayez.');
      }
    } catch (error) {
      showError('reset-error', 'Impossible de réinitialiser le mot de passe. Vérifiez le code ou réessayez.');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Réinitialiser le mot de passe';
    }
  });

  // Back button
  document.getElementById('back-btn').addEventListener('click', () => {
    showStep('request-step');
    hideError('reset-error');
  });
</script>